# Story 4.3: WhatsApp Web-Style Conversation Interface

## Status
Draft

## Story
**As a** business owner/administrator,
**I want** a WhatsApp Web-like interface to view and manage all advisor conversations,
**so that** I can monitor all communications, track message delivery, respond to advisors, and maintain oversight of the entire messaging system from a single dashboard

## Acceptance Criteria
1. Web interface displays all advisors in a left sidebar similar to WhatsApp Web
2. Clicking an advisor shows full conversation history in the main panel
3. Real-time updates when new messages are sent or received via webhooks
4. Shows message status indicators (sent, delivered, read, failed)
5. Ability to send direct messages to advisors from the interface
6. Search functionality to find specific advisors or messages
7. Display advisor profile information (name, ARN, phone, last active)
8. Show rich media properly (images, documents, buttons) in conversations
9. Export conversation history for compliance/audit purposes
10. Mobile-responsive design that works on tablets and phones
11. Unread message counts and notifications for new incoming messages
12. Multi-select capability to send broadcast messages to multiple advisors

## Tasks / Subtasks
- [ ] Task 1: Create WhatsApp-style UI framework (AC: 1, 2, 10)
  - [ ] Build responsive layout with sidebar and conversation panel
  - [ ] Implement advisor list component with avatar/status
  - [ ] Create message bubble components (sent/received)
  - [ ] Add conversation header with advisor info
  - [ ] Implement responsive design for mobile/tablet
- [ ] Task 2: Integrate message history storage (AC: 2, 8)
  - [ ] Create message database schema (SQLite or JSON storage)
  - [ ] Store all sent messages with metadata
  - [ ] Capture incoming messages via webhooks
  - [ ] Index messages for fast retrieval
  - [ ] Handle media message storage (images, documents)
- [ ] Task 3: Implement real-time updates (AC: 3, 4, 11)
  - [ ] Set up WebSocket connection for live updates
  - [ ] Integrate WhatsApp webhooks for message status
  - [ ] Update UI when messages are sent/delivered/read
  - [ ] Show typing indicators if available
  - [ ] Add notification system for new messages
- [ ] Task 4: Build message sending capability (AC: 5, 12)
  - [ ] Create message input component with rich text
  - [ ] Implement send message API integration
  - [ ] Add media attachment support
  - [ ] Build broadcast message functionality
  - [ ] Add message templates quick-select
- [ ] Task 5: Add search and filtering (AC: 6, 7)
  - [ ] Implement advisor search in sidebar
  - [ ] Add message content search
  - [ ] Create date range filters
  - [ ] Add status filters (active, inactive, blocked)
  - [ ] Build advanced search with multiple criteria
- [ ] Task 6: Implement data export and compliance (AC: 9)
  - [ ] Add conversation export to PDF/CSV
  - [ ] Create audit log for all actions
  - [ ] Implement data retention policies
  - [ ] Add compliance report generation
- [ ] Task 7: Testing and deployment (AC: all)
  - [ ] Unit tests for UI components
  - [ ] Integration tests for message flow
  - [ ] Load testing with 100+ advisors
  - [ ] Security testing for access control
  - [ ] Deploy alongside monitoring dashboard

## Dev Notes

### Previous Story Insights
From Story 3.1:
- WhatsApp webhook server already running on port 5000
- V2 Deliverability Engine handles message sending
- All advisor data tracked in Google Sheets
- Message delivery working with templates and media

From Story 4.2:
- Monitoring dashboard planned for port 8080
- Express.js server architecture established
- Authentication system to be shared

### Architecture Context

#### Integration Points
[Source: architecture/4-integration-architecture.md#4.2, #4.4]
WhatsApp Business API Integration:
- Webhooks already configured for real-time events
- Message status updates available via webhooks
- Need to capture and store: messages.sent, messages.delivered, messages.read, messages.failed

#### Webhook Events to Capture
[Source: Existing webhook server at port 5000]
```javascript
// Incoming webhook events from WhatsApp
{
  "entry": [{
    "changes": [{
      "field": "messages",
      "value": {
        "messages": [/* incoming messages */],
        "statuses": [/* delivery status updates */]
      }
    }]
  }]
}
```

#### Data Storage Strategy
**Decision: Use SQLite for message persistence**
- SQLite chosen for structured queries, reliability, and ACID compliance
- Better performance for conversation history queries
- Supports concurrent read operations

Message schema for SQLite database:
```javascript
// Message table schema
{
  id: 'msg_uuid PRIMARY KEY',
  advisor_id: 'ARN_12345',
  phone: '9876543210',
  direction: 'sent|received',
  type: 'text|image|document|template',
  content: 'message text',
  media_url: 'if applicable',
  status: 'pending|sent|delivered|read|failed',
  timestamp: 'ISO 8601',
  metadata: 'JSON field for flexible data',
  created_at: 'TIMESTAMP DEFAULT CURRENT_TIMESTAMP',
  updated_at: 'TIMESTAMP'
}
// Indexes: advisor_id, phone, timestamp, status
// Data retention: 90 days rolling window
```

### File Structure
```
/monitoring/
  â”œâ”€â”€ whatsapp-interface/
  â”‚   â”œâ”€â”€ server.js           # Express server extension
  â”‚   â”œâ”€â”€ websocket.js        # WebSocket for real-time
  â”‚   â”œâ”€â”€ routes/
  â”‚   â”‚   â”œâ”€â”€ conversations.js # Conversation API
  â”‚   â”‚   â”œâ”€â”€ messages.js     # Message operations
  â”‚   â”‚   â””â”€â”€ webhooks.js     # WhatsApp webhook handler
  â”‚   â”œâ”€â”€ services/
  â”‚   â”‚   â”œâ”€â”€ message-store.js # Message persistence
  â”‚   â”‚   â”œâ”€â”€ whatsapp-sync.js # Sync with WhatsApp
  â”‚   â”‚   â””â”€â”€ export.js       # Export functionality
  â”‚   â”œâ”€â”€ public/
  â”‚   â”‚   â”œâ”€â”€ css/
  â”‚   â”‚   â”‚   â””â”€â”€ whatsapp.css # WhatsApp-like styling
  â”‚   â”‚   â””â”€â”€ js/
  â”‚   â”‚       â”œâ”€â”€ chat.js     # Chat interface logic
  â”‚   â”‚       â””â”€â”€ websocket.js # Client WebSocket
  â”‚   â””â”€â”€ views/
  â”‚       â””â”€â”€ whatsapp.ejs    # WhatsApp interface view
  â””â”€â”€ dashboard/              # From Story 4.2
```

### UI/UX Requirements
WhatsApp Web-like Interface:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FinAdvise Message Center                    [ğŸ”] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Advisors       â”‚ Avalok (ARN_12345)             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚ [A] Avalokâ”‚   â”‚                                 â”‚
â”‚ â”‚ 2 new     â”‚   â”‚ Yesterday                       â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ â”‚ [S] Shrutiâ”‚   â”‚ â”‚ Tax saving tips... â”‚ âœ“âœ“      â”‚
â”‚ â”‚ âœ“âœ“        â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ â”‚ [V] Vidya â”‚   â”‚       â”‚ Thanks! Useful   â”‚      â”‚
â”‚ â”‚ âœ“         â”‚   â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ Today                           â”‚
â”‚ [+ Broadcast]  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚                â”‚ â”‚ Market update...    â”‚ âœ“       â”‚
â”‚                â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                â”‚ [ğŸ“] Type a message...    [Send]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Technical Dependencies
- Socket.io for WebSocket real-time updates
- SQLite or LowDB for message storage
- Multer for file uploads
- Sharp for image processing/thumbnails
- PDFKit for conversation exports
- Moment.js for timestamp formatting

### Security Considerations
- Authenticate all WebSocket connections
- Validate message content before sending
- Sanitize HTML to prevent XSS
- Rate limit message sending
- Encrypt stored messages at rest
- Audit log all admin actions

### Testing Standards
[Source: Existing patterns]
- Test location: `/tests/monitoring/whatsapp-interface/`
- Mock WhatsApp API responses
- Test real-time message updates
- Verify message persistence
- Load test with 100+ concurrent advisors
- Test export functionality

### Integration with Existing Systems
- **Deployment**: Integrated as route `/whatsapp` within Story 4.2 dashboard (port 8080)
- **Authentication**: Shared session management with monitoring dashboard
- **WhatsApp Service**: Use existing service from `/services/whatsapp/`
- **Webhooks**: Extend existing webhook server on port 5000 to capture message events
- **Data Sync**: Pull advisor data from Google Sheets on startup and cache
- **Configuration**: Reuse environment variables from env.config.js

### WebSocket Event Specifications
```javascript
// Client to Server events
'join_conversation': { advisor_id: 'ARN_12345' }
'send_message': { advisor_id, content, type, media? }
'mark_read': { advisor_id, message_id }
'search': { query, filters }

// Server to Client events
'new_message': { message_object }
'status_update': { message_id, status }
'typing': { advisor_id, is_typing }
'advisor_online': { advisor_id, last_seen }
```

## Testing

### Testing Requirements
- **Test Framework**: Jest for unit tests, Puppeteer for UI tests
- **Test Location**: `/tests/monitoring/whatsapp-interface/`
- **Coverage Target**: Minimum 80% code coverage

### Test Scenarios
1. **UI Component Tests**
   - Advisor list renders correctly
   - Conversation view displays messages properly
   - Message bubbles show correct status indicators
   - Search functionality works
   - Mobile responsive layout

2. **WebSocket Tests**
   - Connection establishment
   - Real-time message delivery
   - Status updates propagation
   - Reconnection on disconnect
   - Event handling for all defined events

3. **Message Flow Tests**
   - Send text message successfully
   - Send media message with attachment
   - Receive incoming messages
   - Update message status (sent â†’ delivered â†’ read)
   - Handle failed message scenarios

4. **Data Persistence Tests**
   - Messages saved to SQLite correctly
   - Message retrieval by advisor
   - Search queries return correct results
   - Data retention policy enforced (90 days)
   - Export functionality generates valid files

5. **Integration Tests**
   - WhatsApp webhook integration
   - Authentication with main dashboard
   - Advisor data sync from Google Sheets
   - Broadcast message to multiple advisors

6. **Performance Tests**
   - Load 100+ advisor conversations
   - Handle 50 concurrent WebSocket connections
   - Message search under 100ms
   - UI renders within 1 second

### Mock Requirements
- Mock WhatsApp API responses
- Mock WebSocket connections for testing
- Mock SQLite database for unit tests
- Mock Google Sheets advisor data

### E2E Test Scenarios
- Complete flow: Login â†’ Select Advisor â†’ Send Message â†’ Verify Delivery
- Broadcast flow: Select Multiple â†’ Compose â†’ Send â†’ Verify All
- Export flow: Select Conversation â†’ Export â†’ Verify PDF/CSV

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-11 | 1.0 | Initial story for WhatsApp Web-style interface | Bob (Scrum Master) |
| 2025-01-11 | 1.1 | Added Testing section, storage decisions, WebSocket specs, and integration clarifications | Sarah (Product Owner) |

## Dev Agent Record
_To be populated during implementation_

### Agent Model Used
_To be populated_

### Debug Log References
_To be populated_

### Completion Notes List
_To be populated_

### File List
_To be populated_

## QA Results
_To be populated after implementation_