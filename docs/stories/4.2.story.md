# Story 4.2: Production Monitoring Dashboard & Operations Center

## Status
Draft

## Story
**As a** system administrator,
**I want** a web-based monitoring dashboard and operations center,
**so that** I can monitor system health, track daily operations, manage advisors, and handle issues without SSH access

## Acceptance Criteria
1. Web dashboard accessible at http://VM_IP:8080 with authentication
2. Real-time system health monitoring (PM2 processes, API status, resource usage)
3. Daily operation status tracking (content generation, approval, distribution)
4. **Live agent execution viewer showing real-time agent hierarchy and current activities**
5. Advisor management interface (add/edit/disable advisors without editing sheets)
6. Content review interface showing pending approvals with approve/reject buttons
7. Error log viewer with filtering and search capabilities
8. Manual trigger interface for running agents on-demand
9. Analytics dashboard showing key metrics (advisors served, content generated, delivery rates)
10. Backup/restore functionality for critical data
11. Mobile-responsive design for monitoring on-the-go

## Tasks / Subtasks
- [ ] Task 1: Create Express.js dashboard server (AC: 1, 11)
  - [ ] Set up Express server with authentication middleware
  - [ ] Implement session management and basic auth
  - [ ] Create responsive HTML/CSS templates
  - [ ] Add PM2 as dependency for process monitoring
- [ ] Task 2: Implement system monitoring endpoints (AC: 2, 3)
  - [ ] Create /api/health endpoint for system status
  - [ ] Add PM2 process monitoring integration
  - [ ] Implement resource usage tracking (CPU, memory, disk)
  - [ ] Add WhatsApp API status checker
  - [ ] Create Google Sheets connectivity monitor
- [ ] Task 3: Build live agent execution viewer (AC: 4)
  - [ ] Create real-time agent hierarchy visualization
  - [ ] Implement WebSocket stream for agent activities
  - [ ] Show current agent status (idle, processing, completed, error)
  - [ ] Display agent execution timeline with start/end times
  - [ ] Add agent log viewer for each execution
- [ ] Task 4: Build operations management interface (AC: 5, 6, 8)
  - [ ] Create advisor CRUD interface
  - [ ] Build content approval dashboard
  - [ ] Add manual agent trigger interface
  - [ ] Implement job scheduling viewer/editor
- [ ] Task 5: Develop analytics and reporting (AC: 9)
  - [ ] Create metrics collection service
  - [ ] Build analytics dashboard components
  - [ ] Add daily/weekly/monthly report generation
  - [ ] Implement delivery success rate tracking
- [ ] Task 6: Add error handling and logging viewer (AC: 7)
  - [ ] Create log aggregation service
  - [ ] Build searchable log viewer interface
  - [ ] Add error alert configuration
  - [ ] Implement log rotation and cleanup
- [ ] Task 7: Implement backup and recovery tools (AC: 10)
  - [ ] Create automated backup scheduler
  - [ ] Build backup/restore UI
  - [ ] Add Google Drive backup integration
  - [ ] Implement disaster recovery procedures
- [ ] Task 8: Testing and deployment (AC: all)
  - [ ] Unit tests for all API endpoints
  - [ ] Integration tests for monitoring services
  - [ ] Security testing for authentication
  - [ ] Performance testing under load
  - [ ] Deploy to VM with PM2 configuration

## Dev Notes

### Previous Story Insights
From Story 3.1 (Production Optimization):
- System successfully handles 50+ advisors
- WhatsApp delivery working with V2 engine
- PM2 already managing processes on VM
- Webhook server running on port 5000
- Alert configuration exists in `/monitoring/alert-config.js`

### Architecture Context

#### Agent Hierarchy to Monitor
[Source: architecture/2-agent-architecture.md#2.1]
Real-time visualization of agent execution hierarchy:
```yaml
/content-engine (8:30 PM & 5:00 AM triggers)
├── content-orchestrator
│   ├── content-strategist (web scraping, topic selection)
│   ├── fatigue-checker (variation scoring)
│   ├── content-generator (Claude Opus content)
│   ├── image-creator (Gemini API visuals)
│   ├── compliance-validator (SEBI checks)
│   └── distribution-manager (WhatsApp delivery)
├── approval-guardian (11:00 PM auto-approval)
├── revision-handler (real-time edits)
└── analytics-tracker (metrics collection)
```

The dashboard will show:
- **Live Status**: Each agent's current state (idle, processing, completed, error)
- **Execution Timeline**: Visual timeline showing when each agent runs
- **Progress Indicators**: Real-time progress bars for long-running agents
- **Log Streaming**: Live logs from currently executing agents
- **Performance Metrics**: Execution time, success rate, API calls made

#### Daily Workflow Visualization
At 8:30 PM, users can watch:
1. content-orchestrator starting and reading advisors
2. content-strategist scraping web for topics
3. fatigue-checker validating uniqueness
4. content-generator creating content (progress for each advisor)
5. image-creator generating visuals
6. compliance-validator checking each piece
7. Status updates as each advisor's content is prepared

#### Infrastructure Setup
[Source: architecture/5-infrastructure-architecture.md#5.1]
Dashboard will run on port 8080 as specified:
```yaml
firewall_rules:
  - port: 22 (SSH)
  - port: 5000 (Webhook)
  - port: 8080 (Dashboard)  # Dashboard port already configured
```

#### Process Management Integration
[Source: architecture/5-infrastructure-architecture.md#5.2]
PM2 ecosystem already configured, dashboard needs to integrate:
```javascript
// Existing PM2 apps to monitor
- webhook-server (Python Flask)
- claude-session (Node.js)
- Daily cron jobs for content generation
```

#### Monitoring Requirements
[Source: architecture/1-architecture-overview.md#1.3 - monitoring component referenced]
Key metrics to track:
- Agent execution times
- API rate limit usage
- Content generation success rates
- WhatsApp delivery statistics
- System resource utilization

#### Data Sources
[Source: architecture/4-integration-architecture.md#4.1]
Dashboard will read from:
- Google Sheets (advisor data, content tracking)
  - Advisors tab: name, ARN, phone, status, created_at
  - Content tab: advisor_id, content, status, created_at, delivered_at
  - Analytics tab: metrics, counts, performance data
- PM2 API (process status)
- Local logs (/home/mvp/logs/)
- WhatsApp API (delivery status)
- System metrics (OS level)

### File Structure
Based on existing project:
```
/monitoring/
  ├── dashboard/
  │   ├── server.js          # Express server
  │   ├── routes/
  │   │   ├── api.js         # API endpoints
  │   │   ├── auth.js        # Authentication
  │   │   └── views.js       # Page routes
  │   ├── services/
  │   │   ├── metrics.js     # Metrics collection
  │   │   ├── pm2-monitor.js # PM2 integration
  │   │   └── backup.js      # Backup service
  │   ├── public/
  │   │   ├── css/
  │   │   └── js/
  │   └── views/
  │       ├── index.ejs      # Main dashboard
  │       ├── advisors.ejs   # Advisor management
  │       └── analytics.ejs  # Analytics view
  └── alert-config.js        # Existing alert config
```

### Security Considerations
- Basic authentication required (username/password)
  - Shared authentication system with Story 4.3 WhatsApp interface
  - Single sign-on between dashboard and WhatsApp interface
- Session management with secure cookies
- Rate limiting on API endpoints
- Input validation for all forms
- HTTPS recommended for production (can use Cloudflare tunnel)

### Deployment Architecture
This monitoring dashboard serves as the main operations center and will host:
- Main dashboard at http://VM_IP:8080/
- WhatsApp interface (Story 4.3) at http://VM_IP:8080/whatsapp
- Shared authentication and session management
- Unified navigation between dashboard views

### PM2 Configuration Addition
```javascript
// Add to ecosystem.config.js
{
  name: 'monitoring-dashboard',
  script: '/monitoring/dashboard/server.js',
  instances: 1,
  autorestart: true,
  watch: false,
  env: {
    PORT: 8080,
    NODE_ENV: 'production'
  }
}
```

### Testing Standards
[Source: Existing test patterns]
- Test location: `/tests/monitoring/`
- Use Jest for unit tests
- Mock external services (PM2 API, Google Sheets)
- Test authentication and authorization
- Validate all API endpoints
- Performance test with concurrent users

### Technical Dependencies
- Express.js for web server
- EJS for templating
- PM2 API for process monitoring
- Google Sheets API for data access
- Chart.js for analytics visualization
- Bootstrap for responsive UI
- bcrypt for password hashing

## Testing

### Testing Requirements
- **Test Framework**: Jest for unit and integration tests
- **Test Location**: `/tests/monitoring/dashboard/`
- **Coverage Target**: Minimum 80% code coverage

### Test Scenarios
1. **Authentication Tests**
   - Valid login credentials
   - Invalid login attempts
   - Session management
   - Password hashing verification

2. **API Endpoint Tests**
   - `/api/health` returns system status
   - `/api/advisors` CRUD operations
   - `/api/metrics` returns correct data
   - `/api/triggers` executes agents properly

3. **Integration Tests**
   - PM2 API connection and data retrieval
   - Google Sheets read/write operations
   - WhatsApp API status checks
   - Backup/restore functionality

4. **UI Component Tests**
   - Dashboard renders correctly
   - Real-time updates via WebSocket
   - Mobile responsive design
   - Form validation

5. **Performance Tests**
   - Load testing with 100+ concurrent users
   - API response time under 200ms
   - Dashboard loads within 2 seconds

### Mock Requirements
- Mock PM2 API responses
- Mock Google Sheets API
- Mock WhatsApp API status
- Mock file system for logs

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-11 | 1.0 | Initial story creation for monitoring dashboard | Bob (Scrum Master) |
| 2025-01-11 | 1.1 | Added Testing section, deployment architecture, and clarifications | Sarah (Product Owner) |
| 2025-01-11 | 1.2 | Added live agent execution viewer for real-time monitoring | Sarah (Product Owner) |

## Dev Agent Record
_To be populated during implementation_

### Agent Model Used
_To be populated_

### Debug Log References
_To be populated_

### Completion Notes List
_To be populated_

### File List
_To be populated_

## QA Results
_To be populated after implementation_