# Story 3.2: Click-to-Unlock Strategy with Intelligent Webhook CRM

## Status
Ready for Review

## Story
**As a** financial services platform,
**I want** to implement a Click-to-Unlock content delivery system using WhatsApp UTILITY templates with interactive buttons and an intelligent CRM webhook,
**So that** advisors can receive daily content at 5 AM and unlock marketing materials anytime by clicking buttons (bypassing 24-hour restrictions), while also having natural chat interactions with an AI-powered CRM agent

## Context from Thread Discussion
This story emerged from discovering that:
1. UTILITY templates can have buttons that work beyond 24-hour window
2. Button clicks create a new conversation window allowing unlimited marketing content
3. We need a webhook that differentiates button clicks (content delivery) vs text messages (chat)
4. The system should use Claude on VM for intelligent responses (not external APIs)

## Acceptance Criteria
1. **[DONE]** Domain configured with SSL certificate (hubix.duckdns.org)
2. **[DONE]** Floating IP assigned for permanent webhook URL (139.59.51.237)
3. **[PENDING]** Webhook deployed on Digital Ocean VM handling Meta verification
4. **[PENDING]** Daily UTILITY template sender at 5 AM with interactive buttons
5. **[PENDING]** Button click handler that delivers marketing content immediately
6. **[PENDING]** Text message handler with Claude-powered intelligent responses
7. **[PENDING]** CRM tracking system for all advisor interactions
8. **[PENDING]** Integration with Story 2.1 content generation system
9. **[PENDING]** Differentiation logic between button events and text messages
10. **[PENDING]** 24/7 webhook availability with PM2 process management

## Technical Architecture

### Click-to-Unlock Flow
```
5 AM Daily → Send UTILITY Template → Advisor Sees Buttons → Click Anytime
                                                               ↓
                                                    Opens 24-hour Window
                                                               ↓
                                                    Deliver Marketing Content
```

### Webhook Message Handling
```javascript
// Differentiate interaction types
if (message.type === 'interactive' && message.interactive?.type === 'button_reply') {
    // Handle button clicks - deliver content
    const buttonId = message.interactive.button_reply.id;
    switch(buttonId) {
        case 'UNLOCK_IMAGES':
            await deliverImages(message.from);
            break;
        case 'UNLOCK_CONTENT':
            await deliverPosts(message.from);
            break;
        case 'UNLOCK_UPDATES':
            await deliverMarketUpdates(message.from);
            break;
    }
} else if (message.type === 'text') {
    // Handle text messages - intelligent chat
    const response = await getClaudeResponse(message.text.body);
    await sendMessage(message.from, response);
}
```

## Tasks / Subtasks

### Task 1: Complete Webhook Infrastructure Setup (AC: 1, 2, 3)
- [x] Register domain (hubix.duckdns.org)
- [x] Create floating IP (139.59.51.237)
- [x] Restore VM with all Story 1.1/2.1 files
- [x] Create comprehensive webhook deployment script
- [x] Prepare SSL certificate setup with Let's Encrypt
- [x] Configure Nginx reverse proxy configuration
- [ ] SSH into VM and run webhook setup script
- [ ] Verify webhook with Meta

### Task 2: Implement Daily UTILITY Template System (AC: 4)
- [x] Build daily scheduler to send at 5 AM (daily-utility-sender.js)
- [x] Store button payloads: `UNLOCK_IMAGES`, `UNLOCK_CONTENT`, `UNLOCK_UPDATES`
- [x] Implement fallback for non-template messages
- [x] Add test mode for single advisor testing
- [ ] Create UTILITY template in Meta Business Manager
- [ ] Template name: `advisor_daily_content_ready`

### Task 3: Build Button Click Content Delivery (AC: 5, 8)
- [x] Connect to Story 2.1 content generation output
- [x] Map advisor phone to their generated content
- [x] Implement image delivery from `/generated-images/` directory
- [x] Send multiple messages in sequence when button clicked
- [x] Track delivery status in logs (button-click-handler.js)

### Task 4: Implement Intelligent Chat System (AC: 6, 9)
- [x] Create context-aware response generator (intelligent-chat-system.js)
- [x] Implement conversation memory (last 10 messages)
- [x] Add financial advisory context to responses
- [x] Fallback to intelligent contextual responses if Claude unavailable
- [x] Intent analysis for better response targeting
- [ ] Install Claude on VM (using Claude Code)

### Task 5: Build CRM Tracking System (AC: 7)
- [x] Create interaction database schema (SQLite)
- [x] Track: timestamp, advisor_phone, interaction_type, content_delivered
- [x] Log all button clicks with payload details
- [x] Store chat conversations with context
- [x] Generate daily interaction reports (crm-tracking-system.js)
- [x] Analytics API endpoints for real-time monitoring

### Task 6: Integration and Testing (AC: all)
- [x] Create comprehensive test suite (test-story-3.2-integration.js)
- [x] Test webhook verification logic
- [x] Test button click events handling
- [x] Test text message response generation
- [x] Test content delivery pipeline
- [ ] Deploy to VM and test with Meta
- [ ] Load test with 50+ advisors
- [ ] Verify 24-hour window bypass works

## Current Status & What Happened

### Infrastructure Journey
1. **Started with Cloudflare tunnel** - Unreliable, URL kept changing
2. **User suggestion** - "We have a VM, why not use it?"
3. **Discovered Meta requirements** - HTTPS with valid SSL required
4. **DuckDNS solution** - Free domain + Let's Encrypt SSL
5. **Accidental VM deletion** - Recovered from snapshot
6. **Current state** - VM restored, domain configured, needs webhook deployment

### Key Discoveries
- Meta rejects HTTP and self-signed certificates
- UTILITY templates bypass 24-hour window with buttons
- Digital Ocean API can't execute SSH commands (security)
- Floating IPs provide permanent addresses
- Cloudflare tunnels are not production-ready

### Files Created
- `/Users/shriyavallabh/Desktop/mvp/webhook-for-vm.js` - Main webhook with button handling
- `/Users/shriyavallabh/Desktop/mvp/webhook-port-80.js` - HTTP version
- `/Users/shriyavallabh/Desktop/mvp/webhook-https-direct.js` - HTTPS version
- `/Users/shriyavallabh/Desktop/mvp/setup-hubix-ssl.sh` - SSL setup script
- `/Users/shriyavallabh/Desktop/mvp/STORY-3.1-WEBHOOK-INTEGRATION-SUMMARY.md` - Complete documentation

## User Requirements from Thread
1. **"Why should somebody type unlock instead of clicking"** - Buttons are better UX
2. **"Use Claude Code IDE, not Gemini API"** - Save costs, use local AI
3. **"No ngrok if chargeable"** - Avoid paid solutions
4. **"You do everything with PAT"** - Full automation expected
5. **"It's a high-stake game"** - Production reliability critical

## Next Steps for Completion

### Immediate Action Required
```bash
# SSH into VM
ssh root@139.59.51.237  # Use password from email

# Run setup from STORY-3.1-WEBHOOK-INTEGRATION-SUMMARY.md
cd /home/mvp/webhook
# [Run all commands from summary file]
```

### After Webhook Setup
1. Configure webhook URL in Meta: `https://hubix.duckdns.org/webhook`
2. Create UTILITY template with buttons
3. Test button click events
4. Implement content delivery logic
5. Add Claude integration for chat

## Dependencies
- Story 1.1: Agent framework (preserved in `/home/mvp/agents/`)
- Story 2.1: Content generation (preserved in `/home/mvp/content/`)
- Story 3.1: WhatsApp integration (templates, API setup)

## Risks & Mitigations
- **Risk**: Meta changes API requirements
  - **Mitigation**: Monitor Meta developer updates
- **Risk**: Claude not available on VM
  - **Mitigation**: Implement smart fallback responses
- **Risk**: Floating IP costs
  - **Mitigation**: Already included in DO pricing

## Success Metrics
- Webhook uptime: 99.9%
- Button click response time: <2 seconds
- Content delivery success rate: >95%
- Chat response relevance: >80% satisfaction
- Daily active advisors: 50+

## Dev Agent Record

### Agent Model Used
- claude-opus-4-1-20250805 (James - Full Stack Developer)

### Debug Log References
- Created comprehensive webhook deployment script (deploy-story-3.2-webhook.sh)
- Implemented daily UTILITY template sender with cron scheduling
- Built button click content delivery system with Story 2.1 integration
- Developed intelligent chat system with Claude fallback to contextual responses
- Created SQLite-based CRM tracking with analytics API
- Built comprehensive integration test suite

### Completion Notes
- [x] All core components implemented and ready for deployment
- [x] Test suite created for validation
- [x] Documentation complete with deployment instructions
- [ ] Pending: VM deployment and Meta webhook configuration
- [ ] Pending: UTILITY template creation in Meta Business Manager

### File List
**New Files Created:**
- `/Users/shriyavallabh/Desktop/mvp/deploy-story-3.2-webhook.sh` - Complete deployment script
- `/Users/shriyavallabh/Desktop/mvp/daily-utility-sender.js` - Daily 5 AM template sender
- `/Users/shriyavallabh/Desktop/mvp/button-click-handler.js` - Button click content delivery
- `/Users/shriyavallabh/Desktop/mvp/intelligent-chat-system.js` - AI-powered chat responses
- `/Users/shriyavallabh/Desktop/mvp/crm-tracking-system.js` - CRM database and analytics
- `/Users/shriyavallabh/Desktop/mvp/test-story-3.2-integration.js` - Integration test suite

**Modified Files:**
- `/Users/shriyavallabh/Desktop/mvp/webhook-for-vm.js` - Updated to use environment variables
- `/Users/shriyavallabh/Desktop/mvp/docs/stories/3.2.story.md` - Updated task completion status

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-11 | 1.0 | Story created from thread discussion | Claude |
| 2025-09-11 | 1.1 | Implemented all components except VM deployment | James (Dev Agent) |

## Notes
This story captures the complete Click-to-Unlock strategy discussed in the thread, including the intelligent CRM webhook concept. It's separate from Story 3.1 (production optimization) as it represents a new feature set rather than optimization of existing functionality.

### Ready for Deployment
All components are implemented and tested locally. Next steps:
1. SSH into VM (139.59.51.237)
2. Run deployment script: `bash deploy-story-3.2-webhook.sh`
3. Configure webhook URL in Meta Business Manager
4. Create UTILITY template in Meta
5. Test end-to-end flow with advisors