# Story 5.1: PM2 Cron Scheduling System

## Status
Ready for Review

## Story
**As a** system administrator,
**I want** an automated PM2 cron scheduling system that triggers content generation at 8:30 PM, auto-approval at 11:00 PM, and distribution at 5:00 AM daily,
**so that** the daily content generation workflow operates completely automatically without manual intervention

## Acceptance Criteria
1. Implement PM2 cron job for evening content generation trigger at 8:30 PM daily
2. Create PM2 cron job for auto-approval guardian activation at 11:00 PM daily
3. Set up PM2 cron job for morning content distribution at 5:00 AM daily
4. Configure content orchestrator to run full agent workflow on evening trigger
5. Implement state management to prevent concurrent execution of scheduled jobs
6. Add logging and monitoring for each scheduled job execution
7. Create manual override commands to trigger any schedule outside of cron timing
8. Configure ecosystem.config.js with proper cron schedules and job isolation
9. Implement graceful handling of failed job executions with retry logic
10. Add health checks to verify all scheduled jobs are properly registered with PM2

## Tasks / Subtasks
- [x] Task 1: Configure PM2 cron scheduling infrastructure (AC: 1, 2, 3, 8)
  - [x] Extend existing ecosystem.config.js with three new cron jobs
  - [x] Create jobs/daily-content-scheduler.js for 8:30 PM trigger
  - [x] Create jobs/auto-approval-scheduler.js for 11:00 PM trigger  
  - [x] Create jobs/morning-distribution-scheduler.js for 5:00 AM trigger
  - [x] Configure proper cron expressions and timezone handling
  - [x] Set up job isolation to prevent resource conflicts

- [x] Task 2: Implement content generation workflow trigger (AC: 4)
  - [x] Create workflow orchestration in daily-content-scheduler.js
  - [x] Integrate with existing content-orchestrator.js agent
  - [x] Configure advisor batch processing pipeline
  - [x] Set up content review package generation
  - [x] Implement WhatsApp admin notification system

- [x] Task 3: Build state management and job coordination (AC: 5, 9)
  - [x] Create shared state store in services/scheduler-state.js
  - [x] Implement job execution locks to prevent concurrency
  - [x] Add job status tracking and completion verification
  - [x] Create retry mechanism for failed job executions
  - [x] Implement graceful error handling and recovery

- [x] Task 4: Add comprehensive logging and monitoring (AC: 6)
  - [x] Extend existing logger utility for scheduled job events
  - [x] Create structured logs for each job phase
  - [x] Implement job execution metrics collection
  - [x] Add performance tracking for job duration
  - [x] Create debug logs for troubleshooting failures

- [x] Task 5: Create manual override capabilities (AC: 7)
  - [x] Build CLI commands for manual job triggers
  - [x] Create scripts/trigger-evening-generation.js
  - [x] Create scripts/trigger-auto-approval.js  
  - [x] Create scripts/trigger-morning-distribution.js
  - [x] Add parameter passing for selective advisor processing

- [x] Task 6: Implement health checks and job verification (AC: 10)
  - [x] Create PM2 job registration verification
  - [x] Build health check endpoints in monitoring dashboard
  - [x] Add cron schedule validation
  - [x] Implement job heartbeat monitoring
  - [x] Create alerting for failed or missing job executions

- [x] Task 7: Testing and validation
  - [x] Create test suite in tests/unit/jobs/
  - [x] Test cron expression parsing and execution
  - [x] Validate job isolation and state management
  - [x] Test manual trigger functionality
  - [x] Verify integration with existing monitoring dashboard

## Dev Notes

### Previous Story Insights
[Source: Story 4.4 Dev Agent Record]

The monitoring dashboard infrastructure from Story 4.4 provides:
- Existing services/metrics.js for tracking job execution
- services/websocket-server.js for real-time job status updates
- Database analytics.db for storing job execution history
- PM2 monitoring integration already established

### Architecture Context
[Source: architecture/2-agent-architecture.md]

**Agent Orchestration Pattern:**
- Master Controller: `/content-engine` parent command
- content-orchestrator (Level 1) - coordinates all content operations
- Sub-agents: content-strategist, fatigue-checker, content-generator, image-creator, compliance-validator, distribution-manager (Level 2)
- approval-guardian (Level 1) - separate from orchestrator for auto-approval timing

### Infrastructure Requirements  
[Source: architecture/5-infrastructure-architecture.md]

**PM2 Process Management:**
- Existing ecosystem.config.js structure in place
- Current apps: webhook-server, claude-session with cron_restart
- Process isolation and resource management configured
- Logging infrastructure: error_file, out_file, log_file paths established
- Max memory restart thresholds defined

### Daily Workflow Architecture
[Source: docs/prd/16-complete-daily-workflow-summary.md]

**Required Timing:**
- 8:30 PM: PM2 triggers /content-engine on VM → Generates content for all advisors → Creates review package → Sends to admin WhatsApp
- 11:00 PM: Auto-approval if no manual approval → Approval-guardian activates → Quality checks → Regenerates if needed
- 5:00 AM: Morning distribution → Reads approved content → Sends to all advisors → Updates analytics

**State Management Requirements:**
- Session tracking with unique session IDs
- Agent state management (IDLE, PROCESSING, COMPLETED, ERROR)
- Workflow coordination between orchestrator and approval-guardian
- Review window tracking (8:30-11:00 PM)

### File Structure Extensions
```
jobs/
├── daily-content-scheduler.js (NEW - 8:30 PM trigger)
├── auto-approval-scheduler.js (NEW - 11:00 PM trigger)  
├── morning-distribution-scheduler.js (NEW - 5:00 AM trigger)
└── scheduler-state.js (NEW - shared state management)

scripts/ (extend existing)
├── trigger-evening-generation.js (NEW)
├── trigger-auto-approval.js (NEW)
├── trigger-morning-distribution.js (NEW)

config/
└── ecosystem.config.js (EXTEND - add 3 cron jobs)

monitoring/dashboard/services/
└── job-monitor.js (NEW - scheduled job tracking)
```

### Technology Stack
[Source: architecture/1-architecture-overview.md]

**Scheduling Components:**
- PM2 cron_restart functionality for job scheduling
- Node.js child_process for agent execution
- Existing Claude CLI integration for agent triggers
- Flask webhook server for real-time event processing
- Google Sheets integration for advisor data access

### Testing Standards
[Source: architecture/testing patterns from Stories 1.1-4.4]

**Test Requirements:**
- Test files: `tests/unit/jobs/`
- Integration tests: `tests/integration/test-scheduled-workflows.js`
- Use existing jest framework from package.json
- Mock PM2 cron functionality for unit tests
- Test job state management and concurrency handling
- Validate cron expression parsing and execution timing

### Performance Requirements
[Source: docs/prd/3-product-requirements.md]

- Content generation: <2 minutes per advisor
- Daily batch processing: 1000 advisors in 30 minutes  
- Job execution overlap prevention
- Graceful handling of VM resource constraints
- Monitoring dashboard real-time job status updates

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-13 | 1.0 | Initial story creation for Epic 5 - Daily Workflow Automation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
- Integration tests: `/tests/integration/test-scheduled-workflows.js`
- Unit tests: `/tests/unit/jobs/`
- Job logs: `/logs/content-scheduler-*.log`, `/logs/auto-approval-*.log`, `/logs/morning-distribution-*.log`

### Completion Notes
1. **PM2 Cron Infrastructure**: Successfully extended ecosystem.config.js with three new cron jobs for daily content generation (8:30 PM), auto-approval (11:00 PM), and morning distribution (5:00 AM)

2. **Job Schedulers**: Implemented three main scheduler files with robust error handling, timeout management, and WhatsApp admin notifications

3. **State Management**: Created SchedulerState service with job locking, status tracking, and persistence to prevent concurrent execution

4. **Enhanced Logging**: Extended existing Logger utility with specialized methods for scheduled job events, performance metrics, and debugging

5. **Manual Triggers**: Built CLI scripts for manual job execution with dry-run capabilities, parameter passing, and comprehensive help documentation

6. **Health Monitoring**: Integrated with existing monitoring dashboard by adding new API endpoints for job health checks, alerts, and cron schedule validation

7. **Testing**: Created comprehensive test suite including unit tests for scheduler state and integration tests for the complete workflow

### File List
**New Files:**
- `jobs/daily-content-scheduler.js` - Evening content generation scheduler
- `jobs/auto-approval-scheduler.js` - Nighttime auto-approval scheduler  
- `jobs/morning-distribution-scheduler.js` - Morning distribution scheduler
- `services/scheduler-state.js` - Job state management and coordination
- `scripts/trigger-evening-generation.js` - Manual content generation trigger
- `scripts/trigger-auto-approval.js` - Manual auto-approval trigger
- `scripts/trigger-morning-distribution.js` - Manual distribution trigger
- `monitoring/dashboard/services/job-monitor.js` - Job monitoring service
- `tests/unit/jobs/scheduler-state.test.js` - Unit tests for state management
- `tests/unit/jobs/daily-content-scheduler.test.js` - Unit tests for content scheduler
- `tests/integration/test-scheduled-workflows.js` - Integration test suite

**Modified Files:**
- `config/ecosystem.config.js` - Added three new PM2 cron jobs
- `agents/utils/logger.js` - Added scheduled job logging methods
- `agents/controllers/content-orchestrator.js` - Added batch mode support
- `agents/managers/advisor-manager.js` - Added getAllActiveAdvisors and getAdvisorById methods
- `monitoring/dashboard/routes/api.js` - Added job health check endpoints

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-13 | 1.1 | Implemented complete PM2 cron scheduling system with state management, monitoring, and testing | James (Dev Agent) |

## QA Results

### Review Date: 2025-09-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Excellent implementation** that demonstrates sophisticated understanding of production scheduling systems. The implementation includes:

- **State Management**: Robust SchedulerState service with proper concurrency control using file-based locking
- **Error Handling**: Comprehensive error handling with graceful degradation and proper timeout management
- **Testing**: Outstanding test coverage with both unit tests and integration tests achieving 100% pass rate
- **Logging**: Enhanced logger utility with structured logging for scheduled job events
- **CLI Tools**: Professional-grade manual override scripts with dry-run capabilities and comprehensive help
- **Monitoring Integration**: Seamless integration with existing monitoring dashboard via new API endpoints

### Refactoring Performed

No refactoring was necessary - the code quality is already at production standard.

### Compliance Check

- **Coding Standards**: ✓ Excellent adherence to Node.js best practices
- **Project Structure**: ✓ Perfect integration with existing architecture  
- **Testing Strategy**: ✓ Comprehensive test suite with unit and integration tests
- **All ACs Met**: ✓ All 10 acceptance criteria fully implemented and validated

### Requirements Traceability (Given-When-Then)

**AC1: Evening content generation cron (8:30 PM)**
- **Given** PM2 ecosystem.config.js has daily-content-scheduler configured  
- **When** 8:30 PM arrives daily in Asia/Kolkata timezone
- **Then** PM2 triggers content generation workflow via batch mode
- **Test Coverage**: ✓ PM2 config validation, cron expression tests, scheduler health checks

**AC2: Auto-approval cron (11:00 PM)**  
- **Given** Auto-approval scheduler is registered with PM2
- **When** 11:00 PM arrives daily
- **Then** Approval guardian activates for pending content review
- **Test Coverage**: ✓ Scheduler instantiation, timing validation, dry-run tests

**AC3: Morning distribution cron (5:00 AM)**
- **Given** Morning distribution scheduler configured in PM2  
- **When** 5:00 AM arrives daily
- **Then** Distribution manager sends approved content to all advisors
- **Test Coverage**: ✓ Configuration validation, manual trigger tests

**AC4: Content orchestrator integration**
- **Given** Daily content scheduler triggers
- **When** Batch mode is activated with evening-trigger flag  
- **Then** Content orchestrator runs full agent workflow for all advisors
- **Test Coverage**: ✓ Batch mode implementation, process spawning, output parsing

**AC5: State management for concurrency prevention**
- **Given** Multiple jobs could execute simultaneously
- **When** Job attempts to acquire lock
- **Then** SchedulerState prevents concurrent execution with job locking
- **Test Coverage**: ✓ Lock acquisition/release, concurrency prevention, state persistence

**AC6: Logging and monitoring**
- **Given** Scheduled jobs execute
- **When** Jobs run through various phases  
- **Then** Enhanced logger captures structured job events with metrics
- **Test Coverage**: ✓ Job logging methods, monitoring dashboard integration

**AC7: Manual override commands**
- **Given** Need to trigger jobs outside schedule
- **When** Manual trigger scripts are executed
- **Then** Jobs run with dry-run capability and parameter passing
- **Test Coverage**: ✓ Manual trigger functionality, CLI argument parsing, dry-run validation

**AC8: PM2 ecosystem configuration**  
- **Given** Three new scheduled jobs need PM2 management
- **When** Ecosystem.config.js is loaded
- **Then** Proper cron schedules and job isolation are configured  
- **Test Coverage**: ✓ PM2 configuration validation, cron expression validation

**AC9: Failed job execution handling**
- **Given** Job execution may fail
- **When** Errors occur during job processing
- **Then** Graceful error handling with retry logic and proper cleanup
- **Test Coverage**: ✓ Error handling tests, timeout management, retry mechanisms

**AC10: Health checks and PM2 registration**
- **Given** Scheduled jobs must be monitored
- **When** Health checks are performed  
- **Then** Job registration verification and monitoring dashboard integration
- **Test Coverage**: ✓ Health check endpoints, job monitoring service, alerting system

### Security Review

**PASS** - No security concerns identified:
- Job isolation properly configured in PM2
- No sensitive data exposure in logs  
- Timeout protections prevent resource exhaustion
- State file access is properly controlled
- CLI scripts validate inputs appropriately

### Performance Considerations

**PASS** - Performance requirements met:
- Appropriate timeouts: 30 min (content), 10 min (approval), 15 min (distribution)
- Memory limits configured: 300M for content/distribution, 200M for approval
- Job execution overlap prevention via state management
- Graceful handling of VM resource constraints
- Real-time monitoring dashboard updates

### Files Modified During Review

None - no modifications were necessary during review.

### Gate Status

Gate: **PASS** → docs/qa/gates/5.1-pm2-cron-scheduling-system.yml

### Recommended Status

**✓ Ready for Done** 

Outstanding implementation that exceeds expectations. The scheduling system is production-ready with comprehensive error handling, excellent test coverage, and robust monitoring integration. No changes required.

**Quality Score: 95/100**